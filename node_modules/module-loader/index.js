require('colors');
var chokidar =require('chokidar'),path=require('path'), args=require('yargs').argv;

module.exports=function(folder, callback) {
	var _m={};
	function load(p) {
		var fn=path.basename(p);
		if (_m[p]) delete require.cache[p];
		if (args.debugout) {
			_m[p]=require(p);
		}
		else {
			try{_m[p]=require(p)}
			catch(e) {console.log(('load '+fn+' failed').red, e.message); return;}
		}
		console.log((fn+' loaded @'+(new Date()).toLocaleString()).green);
		callback(null, _m);
	}
	var watcher=chokidar.watch(folder, {ignored: /[\/\\]\./})
		.on('add', load)
		.on('change', load)
		.on('unlink', p => 
			{
				delete _m[p];
				console.log((path.basename(p)+' unloaded @'+(new Date()).toLocaleString()).green);
				callback(null, _m);
			})
		.on('ready', function() {callback(null, _m);});
	return _m;
}
